<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAMAL AL-SHUWAIKH - Tailor Management System</title>
    <link rel="stylesheet" href="styles.css">
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <!-- Top Header -->
    <header class="top-header">
        <div class="header-content">
            <div class="shop-branding">
                <h1>JAMAL AL-SHUWAIKH</h1>
                <p class="shop-subtitle">MEN TAILOR & TEXTILE</p>
                <p class="shop-arabic">ÿ¨ŸÖÿßŸÑ ÿßŸÑÿ¥ŸàŸäÿÆ ŸÑŸÑÿ±ÿ¨ÿßŸÑ ŸàŸÅŸÜÿ≥ÿ™Ÿáÿß</p>
            </div>
            <div class="shop-contact">
                <p>üìû 97686004</p>
                <p>üìç Kuwait ‚Äì Comm. Area No. 9 ‚Äì Mariam Comp ‚Äì Basement ‚Äì Shop No. 8</p>
            </div>
        </div>
    </header>

    <!-- Quick Actions Bar -->
    <div class="quick-actions-bar">
        <div class="actions-container">
            <button class="action-btn" onclick="showSection('clients')">üë• Clients</button>
            <button class="action-btn" onclick="showSection('orders')">üì¶ Orders</button>
            <button class="action-btn" onclick="showSection('invoices')">üßæ Invoices</button>
            <button class="action-btn" onclick="showSection('expenses')">üí∏ Expenses</button>
            <button class="action-btn" onclick="downloadBackup()">üíæ Backup</button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Forms Section -->
        <section class="forms-section">
            <h2 id="formsTitle">üë• Add New Client</h2>
            
            <!-- Client Form -->
            <div id="clientFormSection">
                <form id="clientForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" id="clientName" required placeholder="Enter client name">
                        </div>
                        <div class="form-group">
                            <label>Phone Number *</label>
                            <input type="tel" id="clientPhone" required placeholder="Enter phone number">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Book Number *</label>
                        <input type="text" id="clientBookNo" required placeholder="Enter book number">
                    </div>

                    <div class="form-group">
                        <label>Basic Measurements</label>
                        <div class="measurements-grid">
                            <input type="number" id="measureChest" placeholder="Chest (cm)" step="0.1">
                            <input type="number" id="measureWaist" placeholder="Waist (cm)" step="0.1">
                            <input type="number" id="measureLength" placeholder="Length (cm)" step="0.1">
                            <input type="number" id="measureSleeve" placeholder="Sleeve (cm)" step="0.1">
                        </div>
                    </div>

                    <button type="button" class="btn-primary" onclick="saveClient()">üíæ Save Client</button>
                </form>
            </div>

            <!-- Order Form -->
            <div id="orderFormSection" style="display: none;">
                <form id="orderForm">
                    <div class="search-container">
                        <input type="text" id="orderClientSearch" placeholder="üîç Search client by name, phone, or book number..." 
                               onkeyup="searchOrderClients()">
                        <div id="orderClientResults" class="search-results"></div>
                    </div>

                    <div id="selectedOrderClient" class="client-info-display" style="display: none; margin-bottom: 20px;">
                        <div class="client-details-card">
                            <h4 id="selectedOrderClientName"></h4>
                            <p>üìû <span id="selectedOrderClientPhone"></span></p>
                            <p>üìñ Book No: <span id="selectedOrderClientBookNo"></span></p>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Order Number *</label>
                            <input type="text" id="orderNumber" required value="ORD-${Date.now().toString().slice(-6)}">
                        </div>
                        <div class="form-group">
                            <label>Order Date *</label>
                            <input type="date" id="orderDate" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Garment Type *</label>
                        <select id="orderGarmentType" required>
                            <option value="">-- Select Garment --</option>
                            <option value="thobe">Thobe/Dishdasha</option>
                            <option value="suit">Suit</option>
                            <option value="shirt">Shirt</option>
                            <option value="pants">Pants</option>
                            <option value="jacket">Jacket</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Description *</label>
                        <textarea id="orderDescription" required rows="2" placeholder="Order details..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Price (KWD) *</label>
                            <input type="number" id="orderPrice" required step="0.001" min="0">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="orderStatus">
                                <option value="received">üì• Received</option>
                                <option value="process">‚öôÔ∏è In Process</option>
                                <option value="pending">‚è≥ Pending</option>
                                <option value="completed">‚úÖ Completed</option>
                            </select>
                        </div>
                    </div>

                    <button type="button" class="btn-primary" onclick="saveOrder()">üíæ Save Order</button>
                </form>
            </div>

            <!-- Invoice Form -->
            <div id="invoiceFormSection" style="display: none;">
                <form id="invoiceForm">
                    <div class="search-container">
                        <input type="text" id="invoiceClientSearch" placeholder="üîç Search client by name, phone, or book number..." 
                               onkeyup="searchInvoiceClients()">
                        <div id="invoiceClientResults" class="search-results"></div>
                    </div>

                    <div id="selectedInvoiceClient" class="client-info-display" style="display: none; margin-bottom: 20px;">
                        <div class="client-details-card">
                            <h4 id="selectedInvoiceClientName"></h4>
                            <p>üìû <span id="selectedInvoiceClientPhone"></span></p>
                            <p>üìñ Book No: <span id="selectedInvoiceClientBookNo"></span></p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Invoice Items</label>
                        <div id="invoiceItems">
                            <div class="form-row" style="grid-template-columns: 2fr 1fr 1fr auto; align-items: end; gap: 10px; margin-bottom: 10px;">
                                <input type="text" placeholder="Item description" class="invoice-item-name" required>
                                <input type="number" placeholder="Qty" value="1" class="invoice-item-qty" min="1" required>
                                <input type="number" placeholder="Price (KWD)" class="invoice-item-price" step="0.001" min="0" required>
                                <button type="button" class="btn-danger" onclick="removeInvoiceItem(this)" style="padding: 8px 12px;">üóëÔ∏è</button>
                            </div>
                        </div>
                        <button type="button" class="btn-outline" onclick="addInvoiceItem()" style="margin-top: 10px;">+ Add Item</button>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Discount (KWD)</label>
                            <input type="number" id="invoiceDiscount" value="0" step="0.001" min="0">
                        </div>
                        <div class="form-group">
                            <label>Tax (KWD)</label>
                            <input type="number" id="invoiceTax" value="0" step="0.001" min="0">
                        </div>
                    </div>

                    <button type="button" class="btn-primary" onclick="createInvoice()">üßæ Create Invoice</button>
                </form>
            </div>

            <!-- Expense Form -->
            <div id="expenseFormSection" style="display: none;">
                <form id="expenseForm">
                    <div class="form-group">
                        <label>Expense Type *</label>
                        <select id="expenseType" required>
                            <option value="">-- Select Type --</option>
                            <option value="material">üßµ Material</option>
                            <option value="salary">üë• Salary</option>
                            <option value="rent">üè™ Rent</option>
                            <option value="utility">‚ö° Utility</option>
                            <option value="other">üì¶ Other</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Amount (KWD) *</label>
                            <input type="number" id="expenseAmount" required step="0.001" min="0">
                        </div>
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="date" id="expenseDate" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="expenseDescription" rows="2" placeholder="Expense details..."></textarea>
                    </div>

                    <button type="button" class="btn-primary" onclick="saveExpense()">üíæ Save Expense</button>
                </form>
            </div>
        </section>

        <!-- Data Section -->
        <section class="data-section">
            <h2 id="dataTitle">üë• Clients List</h2>
            
            <!-- Search Bar -->
            <div class="search-container">
                <input type="text" id="dataSearch" placeholder="üîç Search by name, phone, book number..." onkeyup="searchData()">
            </div>

            <!-- Tabs -->
            <div class="data-tabs">
                <button class="tab-btn active" onclick="showDataTab('clients')">üë• Clients</button>
                <button class="tab-btn" onclick="showDataTab('orders')">üì¶ Orders</button>
                <button class="tab-btn" onclick="showDataTab('invoices')">üßæ Invoices</button>
                <button class="tab-btn" onclick="showDataTab('expenses')">üí∏ Expenses</button>
            </div>

            <!-- Data Lists -->
            <div id="clientsData" class="clients-list"></div>
            <div id="ordersData" class="orders-list" style="display: none;"></div>
            <div id="invoicesData" class="clients-list" style="display: none;"></div>
            <div id="expensesData" class="clients-list" style="display: none;"></div>

            <!-- Invoice Preview -->
            <div id="invoicePreview" class="invoice-preview" style="display: none;"></div>
        </section>
    </main>

    <script src="db.js"></script>
    <script src="script.js"></script>
    <script>
        let currentSection = 'clients';
        let currentDataTab = 'clients';
        let selectedOrderClientId = null;
        let selectedInvoiceClientId = null;
        let currentInvoice = null;

        // Search Functions
        function searchOrderClients() {
            const query = document.getElementById('orderClientSearch').value;
            const results = searchClients(query);
            const container = document.getElementById('orderClientResults');
            
            showSearchResults(results, container, 'order');
        }

        function searchInvoiceClients() {
            const query = document.getElementById('invoiceClientSearch').value;
            const results = searchClients(query);
            const container = document.getElementById('invoiceClientResults');
            
            showSearchResults(results, container, 'invoice');
        }

        function showSearchResults(results, container, type) {
            if (results.length === 0) {
                container.innerHTML = '<div class="search-result-item">No clients found</div>';
                container.style.display = 'block';
                return;
            }

            container.innerHTML = results.slice(0, 5).map(client => `
                <div class="search-result-item">
                    <div class="client-search-info">
                        <strong>${client.name}</strong>
                        <div class="client-search-details">
                            <span>üìû ${client.phone}</span>
                            <span>üìñ ${client.bookNo || 'No Book No'}</span>
                        </div>
                    </div>
                    <button class="select-client-btn" onclick="select${type.charAt(0).toUpperCase() + type.slice(1)}Client('${client.id}')">
                        Select
                    </button>
                </div>
            `).join('');
            
            container.style.display = 'block';
        }

        function selectOrderClient(clientId) {
            const client = getClientById(clientId);
            if (client) {
                selectedOrderClientId = clientId;
                document.getElementById('selectedOrderClientName').textContent = client.name;
                document.getElementById('selectedOrderClientPhone').textContent = client.phone;
                document.getElementById('selectedOrderClientBookNo').textContent = client.bookNo || 'N/A';
                document.getElementById('selectedOrderClient').style.display = 'block';
                document.getElementById('orderClientResults').style.display = 'none';
                document.getElementById('orderClientSearch').value = client.name;
            }
        }

        function selectInvoiceClient(clientId) {
            const client = getClientById(clientId);
            if (client) {
                selectedInvoiceClientId = clientId;
                document.getElementById('selectedInvoiceClientName').textContent = client.name;
                document.getElementById('selectedInvoiceClientPhone').textContent = client.phone;
                document.getElementById('selectedInvoiceClientBookNo').textContent = client.bookNo || 'N/A';
                document.getElementById('selectedInvoiceClient').style.display = 'block';
                document.getElementById('invoiceClientResults').style.display = 'none';
                document.getElementById('invoiceClientSearch').value = client.name;
            }
        }

        // Invoice Functions
        function addInvoiceItem() {
            const container = document.getElementById('invoiceItems');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'form-row';
            itemDiv.style.gridTemplateColumns = '2fr 1fr 1fr auto';
            itemDiv.style.alignItems = 'end';
            itemDiv.style.gap = '10px';
            itemDiv.style.marginBottom = '10px';
            
            itemDiv.innerHTML = `
                <input type="text" placeholder="Item description" class="invoice-item-name" required>
                <input type="number" placeholder="Qty" value="1" class="invoice-item-qty" min="1" required>
                <input type="number" placeholder="Price (KWD)" class="invoice-item-price" step="0.001" min="0" required>
                <button type="button" class="btn-danger" onclick="removeInvoiceItem(this)" style="padding: 8px 12px;">üóëÔ∏è</button>
            `;
            
            container.appendChild(itemDiv);
        }

        function removeInvoiceItem(button) {
            if (document.querySelectorAll('#invoiceItems .form-row').length > 1) {
                button.parentElement.remove();
            }
        }

        function createInvoice() {
            if (!selectedInvoiceClientId) {
                showNotification('Please select a client', 'error');
                return;
            }

            const client = getClientById(selectedInvoiceClientId);
            const items = [];
            let subtotal = 0;

            // Get items
            document.querySelectorAll('#invoiceItems .form-row').forEach(row => {
                const name = row.querySelector('.invoice-item-name').value;
                const qty = parseFloat(row.querySelector('.invoice-item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.invoice-item-price').value) || 0;
                
                if (name && qty > 0 && price > 0) {
                    const total = qty * price;
                    items.push({ name, qty, price, total });
                    subtotal += total;
                }
            });

            if (items.length === 0) {
                showNotification('Please add at least one item', 'error');
                return;
            }

            const discount = parseFloat(document.getElementById('invoiceDiscount').value) || 0;
            const tax = parseFloat(document.getElementById('invoiceTax').value) || 0;
            const grandTotal = subtotal - discount + tax;

            const invoice = {
                id: generateId(),
                invoiceNumber: generateInvoiceNumber(),
                clientId: selectedInvoiceClientId,
                clientName: client.name,
                clientPhone: client.phone,
                clientBookNo: client.bookNo,
                items: items,
                subtotal: subtotal,
                discount: discount,
                tax: tax,
                grandTotal: grandTotal,
                invoiceDate: new Date().toISOString(),
                status: 'unpaid'
            };

            saveInvoiceToDB(invoice);
            showInvoicePreview(invoice);
            showNotification('Invoice created successfully!');
        }

        function showInvoicePreview(invoice) {
            currentInvoice = invoice;
            const container = document.getElementById('invoicePreview');
            
            container.innerHTML = `
                <div class="invoice-header">
                    <h2>JAMAL AL-SHUWAIKH</h2>
                    <p class="shop-arabic">ÿ¨ŸÖÿßŸÑ ÿßŸÑÿ¥ŸàŸäÿÆ ŸÑŸÑÿ±ÿ¨ÿßŸÑ ŸàŸÅŸÜÿ≥ÿ™Ÿáÿß</p>
                    <p class="shop-subtitle">MEN TAILOR & TEXTILE</p>
                    <div class="invoice-number">Invoice: ${invoice.invoiceNumber}</div>
                </div>

                <div class="invoice-details">
                    <div class="invoice-section">
                        <h3>Bill To:</h3>
                        <p><strong>${invoice.clientName}</strong></p>
                        <p>üìû ${invoice.clientPhone}</p>
                        <p>üìñ Book No: ${invoice.clientBookNo || 'N/A'}</p>
                    </div>
                    <div class="invoice-section">
                        <h3>Invoice Details:</h3>
                        <p><strong>Date:</strong> ${new Date(invoice.invoiceDate).toLocaleDateString()}</p>
                        <p><strong>Status:</strong> ${invoice.status.toUpperCase()}</p>
                    </div>
                </div>

                <div class="invoice-items">
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Qty</th>
                                <th>Price (KWD)</th>
                                <th>Total (KWD)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoice.items.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.qty}</td>
                                    <td>${item.price.toFixed(3)}</td>
                                    <td>${item.total.toFixed(3)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="invoice-totals">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span>KWD ${invoice.subtotal.toFixed(3)}</span>
                    </div>
                    <div class="total-row">
                        <span>Discount:</span>
                        <span>KWD ${invoice.discount.toFixed(3)}</span>
                    </div>
                    <div class="total-row">
                        <span>Tax:</span>
                        <span>KWD ${invoice.tax.toFixed(3)}</span>
                    </div>
                    <div class="total-row">
                        <span><strong>Grand Total:</strong></span>
                        <span><strong>KWD ${invoice.grandTotal.toFixed(3)}</strong></span>
                    </div>
                </div>

                <div class="qr-container" id="qrCodeContainer">
                    <h3>QR Code for Payment</h3>
                    <div class="qr-code" id="qrCode"></div>
                </div>

                <div class="invoice-actions">
                    <button class="action-btn-large btn-whatsapp" onclick="shareInvoiceWhatsApp()">
                        üì± Share via WhatsApp
                    </button>
                    <button class="action-btn-large btn-pdf" onclick="generateInvoicePDF()">
                        üìÑ Download PDF
                    </button>
                    <button class="action-btn-large btn-print" onclick="printInvoice()">
                        üñ®Ô∏è Print Invoice
                    </button>
                    <button class="action-btn-large btn-qr" onclick="generateQRCode()">
                        üî≥ Generate QR Code
                    </button>
                </div>
            `;

            container.style.display = 'block';
            generateQRCode(); // Auto-generate QR code
        }

        function generateQRCode() {
            if (!currentInvoice) return;
            
            const qrContainer = document.getElementById('qrCode');
            const qrData = `JAMAL AL-SHUWAIKH\nInvoice: ${currentInvoice.invoiceNumber}\nClient: ${currentInvoice.clientName}\nAmount: KWD ${currentInvoice.grandTotal.toFixed(3)}\nDate: ${new Date(currentInvoice.invoiceDate).toLocaleDateString()}\nPhone: 97686004`;
            
            QRCode.toCanvas(qrContainer, qrData, { width: 200 }, function(error) {
                if (error) console.error('QR Code generation error:', error);
            });
        }

        function generateInvoicePDF() {
            if (!currentInvoice) return;
            
            const element = document.getElementById('invoicePreview');
            const opt = {
                margin: 10,
                filename: `invoice-${currentInvoice.invoiceNumber}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Show loading
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="loading-spinner"></span> Generating PDF...';
            button.disabled = true;

            html2pdf().set(opt).from(element).save().then(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                showNotification('PDF downloaded successfully!');
            });
        }

        function printInvoice() {
            const element = document.getElementById('invoicePreview');
            const originalContents = document.body.innerHTML;
            
            document.body.innerHTML = element.innerHTML;
            window.print();
            document.body.innerHTML = originalContents;
            location.reload(); // Reload to restore functionality
        }

        function shareInvoiceWhatsApp() {
            if (!currentInvoice) return;
            
            let message = `*JAMAL AL-SHUWAIKH* üëï\n`;
            message += `ÿ¨ŸÖÿßŸÑ ÿßŸÑÿ¥ŸàŸäÿÆ ŸÑŸÑÿ±ÿ¨ÿßŸÑ ŸàŸÅŸÜÿ≥ÿ™Ÿáÿß\n\n`;
            message += `*INVOICE* üßæ\n`;
            message += `Invoice No: ${currentInvoice.invoiceNumber}\n`;
            message += `Client: ${currentInvoice.clientName}\n`;
            message += `Phone: ${currentInvoice.clientPhone}\n`;
            message += `Date: ${new Date(currentInvoice.invoiceDate).toLocaleDateString()}\n\n`;
            message += `*ITEMS:*\n`;
            
            currentInvoice.items.forEach((item, index) => {
                message += `${index + 1}. ${item.name} - ${item.qty} x KWD ${item.price.toFixed(3)} = KWD ${item.total.toFixed(3)}\n`;
            });
            
            message += `\nSubtotal: KWD ${currentInvoice.subtotal.toFixed(3)}\n`;
            message += `Discount: KWD ${currentInvoice.discount.toFixed(3)}\n`;
            message += `Tax: KWD ${currentInvoice.tax.toFixed(3)}\n`;
            message += `*GRAND TOTAL: KWD ${currentInvoice.grandTotal.toFixed(3)}*\n\n`;
            message += `*Thank you for your business!* üôè\n`;
            message += `üìû 97686004\n`;
            message += `üìç Kuwait ‚Äì Comm. Area No. 9 ‚Äì Mariam Comp ‚Äì Basement ‚Äì Shop No. 8`;

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${currentInvoice.clientPhone}?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }

        // Close search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                document.getElementById('orderClientResults').style.display = 'none';
                document.getElementById('invoiceClientResults').style.display = 'none';
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('orderDate').valueAsDate = new Date();
            document.getElementById('expenseDate').valueAsDate = new Date();
            loadClientsData();
            addInvoiceItem(); // Add first invoice item
        });

        // Add other existing functions (showSection, showDataTab, loadClientsData, etc.)
    </script>
</body>
</html>
